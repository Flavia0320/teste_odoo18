<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="timesheet_plan" model="ir.ui.view">
        <field name="name">Timesheet Plan</field>
        <field name="type">qweb</field>
        <field name="model">project.project</field>
        <field name="priority" eval="50" />
        <field name="inherit_id" ref="sale_timesheet.timesheet_plan"/>
        <field name="arch" type="xml">
            <xpath expr="(//div[hasclass('o_title')])" position="before">
                <t t-set="myproject" t-value="projects"/>
                <t t-if="len(myproject)==1">
                    <div class="o_title_construction" t-if="myproject.is_construction_site">
                        <h2>Construction Resources</h2>
                        <h3 t-field="myproject.name"/>
                        <p>
                          [<a target="_new" t-attf-href="/report/pdf/construction_site.project_project_deviz/#{myproject.id}">
                                <span>Deviz</span>
                            </a>]
                          |
                          [<a target="_new" t-attf-href="/report/pdf/construction_site.project_project_decont/#{myproject.id}">
                                <span>Decont</span>
                            </a>]
                        </p>
                    </div>
                    <div class="o_profitability_wrapper" name="construction_site" t-if="myproject.is_construction_site">
                        <div class="o_profitability_section">
                            <div>
                                <t t-set="all_orders" t-value="myproject.purchase_order_ids"/>
                                <table class="table">
                                    <tbody>
                                        <tr>
                                            <th colspan="3">
                                                <a type="action"
                                                   data-views="[[false, &quot;pivot&quot;], [false, &quot;graph&quot;], [false, &quot;list&quot;]]"
                                                   data-model="project.task.product.report"
                                                   t-att-data-domain="json.dumps([('project_id','=', myproject.id)])"
                                                   data-context="{&quot;pivot_row_groupby&quot;: [&quot;task_id&quot;,&quot;purchase_id&quot;,&quot;product_id&quot;],&quot;pivot_column_groupby&quot;: [&quot;purchase_date:week&quot;], &quot;pivot_measures&quot;: [&quot;required_qty&quot;,&quot;planned_qty&quot;,&quot;received_qty&quot;]}"
                                                   tabindex="-1">
                                                    <span>Purchase Reports</span>
                                                </a>
                                                <a type="action" class="pull-right" data-model="purchase.order" t-att-data-domain="json.dumps([('id','in', all_orders.ids)])" tabindex="-1">
                                                    <span class="oe_button oe_form_button oe_highlight fa fa-shopping-cart"/>
                                                </a>
                                            </th>
                                        </tr>
                                        <tr>
                                            <th>Quantity</th>
                                            <th>Amount</th>
                                            <th>View</th>
                                        </tr>
                                        <tr>
                                            <td class="o_timesheet_plan_dashboard_cell">
                                                <span t-esc="len(all_orders)"/>
                                            </td>
                                            <td class="o_timesheet_plan_dashboard_cell">
                                                <span t-esc="sum(all_orders.mapped('amount_untaxed'))"/>
                                            </td>
                                            <td>
                                                <a type="action" data-model="purchase.order" t-att-data-domain="json.dumps([('id', 'in', all_orders.ids)])" tabindex="-1">
                                                    All Purchases
                                                </a>
                                            </td>
                                        </tr>
                                        <tr>
                                            <t t-set="noreceived" t-value="myproject.purchase_order_by_state('no-receive')"/>
                                            <td class="o_timesheet_plan_dashboard_cell">
                                                <span t-esc="len(noreceived)"/>
                                            </td>
                                            <td class="o_timesheet_plan_dashboard_cell">
                                                <span t-esc="sum(noreceived.mapped('amount_untaxed'))"/>
                                            </td>
                                            <td>
                                                <a type="action" data-model="purchase.order" t-att-data-domain="json.dumps([('id', 'in', noreceived.ids)])" tabindex="-1">
                                                    non delivered
                                                </a>
                                            </td>
                                        </tr>
                                        <tr>
                                            <t t-set="noinvoiced" t-value="myproject.purchase_order_by_state('no-invoice')"/>
                                            <td class="o_timesheet_plan_dashboard_cell">
                                                <span t-esc="len(noinvoiced)"/>
                                            </td>
                                            <td class="o_timesheet_plan_dashboard_cell">
                                                <span t-esc="sum(noinvoiced.mapped('amount_untaxed'))"/>
                                            </td>
                                            <td>
                                                <a type="action" data-model="purchase.order" t-att-data-domain="json.dumps([('id', 'in', noinvoiced.ids)])" tabindex="-1">
                                                    delivered &amp; no-invoiced
                                                </a>
                                            </td>
                                        </tr>
                                        <tr>
                                            <t t-set="complete" t-value="myproject.purchase_order_by_state('complete')"/>
                                            <td class="o_timesheet_plan_dashboard_cell">
                                                <span t-esc="len(complete)"/>
                                            </td>
                                            <td class="o_timesheet_plan_dashboard_cell">
                                                <span t-esc="sum(complete.mapped('amount_untaxed'))"/>
                                            </td>
                                            <td>
                                                <a type="action" data-model="purchase.order" t-att-data-domain="json.dumps([('id', 'in', complete.ids)])" tabindex="-1">
                                                    delivered &amp; invoiced
                                                </a>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="o_profitability_section">
                            <div>
                                <table class="table">
                                    <tbody>
                                        <tr>
                                            <th colspan="3">
                                                <a type="action"
                                                   data-views="[[false, &quot;pivot&quot;], [false, &quot;graph&quot;], [false, &quot;list&quot;]]"
                                                   data-context="{&quot;pivot_row_groupby&quot;: [&quot;task_id&quot;,&quot;picking_id&quot;,&quot;product_id&quot;],&quot;pivot_column_groupby&quot;:[&quot;picking_date:week&quot;], &quot;pivot_measures&quot;: [&quot;required_qty&quot;,&quot;planned_qty&quot;,&quot;received_qty&quot;]}"
                                                   data-model="project.task.move.report"
                                                   t-att-data-domain="json.dumps([('project_id','=',myproject.id)])"
                                                   tabindex="-1">
                                                    <span>Transfers Reports</span>
                                                </a>
                                                <a type="action" class="pull-right" data-model="stock.picking" t-att-data-domain="json.dumps([('id','in',myproject.picking_ids.ids)])" tabindex="-1">
                                                    <span class="oe_button oe_form_button oe_highlight fa fa-truck"/>
                                                </a>
                                            </th>
                                        </tr>
                                        <tr>
                                            <th>Quantity</th>
                                            <th/>
                                            <th>View</th>
                                        </tr>
                                        <tr>
                                            <td class="o_timesheet_plan_dashboard_cell">
                                                <span t-esc="len(myproject.picking_in_ids)"/>
                                            </td>
                                            <td>
                                                <span>-</span>
                                            </td>
                                            <td>
                                                <a type="action" data-model="stock.picking" t-att-data-domain="json.dumps([('id', 'in', myproject.picking_in_ids.ids)])" tabindex="-1">
                                                    Goods Receipt <span t-field="myproject.warehouse_id"/>
                                                </a>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="o_timesheet_plan_dashboard_cell">
                                                <span t-esc="len(myproject.picking_s_in_ids)"/>
                                            </td>
                                            <td>
                                                <span>-</span>
                                            </td>
                                            <td>
                                                <a type="action" data-model="stock.picking" t-att-data-domain="json.dumps([('id', 'in', myproject.picking_s_in_ids.ids)])" tabindex="-1">
                                                    Goods Receipt <span t-field="myproject.supply_warehouse_id"/>
                                                </a>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="o_timesheet_plan_dashboard_cell">
                                                <span t-esc="len(myproject.picking_out_ids)"/>
                                            </td>
                                            <td>
                                                <span>-</span>
                                            </td>
                                            <td>
                                                <a type="action" data-model="stock.picking" t-att-data-domain="json.dumps([('id', 'in', myproject.picking_out_ids.ids)])" tabindex="-1">
                                                    Delivery Notice
                                                </a>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="o_timesheet_plan_dashboard_cell">
                                                <span t-esc="len(myproject.picking_consume_ids)"/>
                                            </td>
                                            <td>
                                                <span>-</span>
                                            </td>
                                            <td>
                                                <a type="action" data-model="stock.picking" t-att-data-domain="json.dumps([('id', 'in', myproject.picking_consume_ids.ids)])" tabindex="-1">
                                                    Consume
                                                </a>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="o_profitability_section">
                            <div>
                                <table class="table">
                                    <tbody>
                                        <tr>
                                            <th colspan="3">
                                                <a type="action"
                                                   data-views="[[false, &quot;pivot&quot;], [false, &quot;graph&quot;]]"
                                                   data-context="{&quot;pivot_row_groupby&quot;: [&quot;move_type&quot;,&quot;move_id&quot;],&quot;pivot_column_groupby&quot;:[&quot;invoice_date:week&quot;], &quot;pivot_measures&quot;: [&quot;price_subtotal&quot;]}"
                                                   data-model="account.invoice.report"
                                                   t-att-data-domain="json.dumps([('move_id','=',myproject.invoice_in_ids.ids + myproject.invoice_out_ids.ids)])"
                                                   tabindex="-1">
                                                    <span>Invoices</span>
                                                </a>
                                                <a type="action" class="pull-right" data-model="account.move" t-att-data-domain="json.dumps([('id','in',myproject.invoice_in_ids.ids + myproject.invoice_out_ids.ids)])" tabindex="-1">
                                                    <span class="oe_button oe_form_button oe_highlight fa fa-fw fa-usd"/>
                                                </a>
                                            </th>
                                        </tr>
                                        <tr>
                                            <th>Quantity</th>
                                            <th>Amount</th>
                                            <th>View</th>
                                        </tr>
                                        <tr>
                                            <td class="o_timesheet_plan_dashboard_cell">
                                                <span t-esc="len(myproject.invoice_out_ids)"/>
                                            </td>
                                            <td>
                                                <span t-esc="sum(myproject.invoice_out_ids.mapped('amount_untaxed'))"/>
                                            </td>
                                            <td>
                                                <a type="action" data-model="account.move" t-att-data-domain="json.dumps([('id', 'in', myproject.invoice_out_ids.ids)])" tabindex="-1">
                                                    Customer Invoices
                                                </a>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="o_timesheet_plan_dashboard_cell">
                                                <span t-esc="len(myproject.invoice_in_ids)"/>
                                            </td>
                                            <td>
                                                <span t-esc="sum(myproject.invoice_in_ids.mapped('amount_untaxed'))"/>
                                            </td>
                                            <td>
                                                <a type="action" data-model="account.move" t-att-data-domain="json.dumps([('id', 'in', myproject.invoice_in_ids.ids)])" tabindex="-1">
                                                    Supplier Invoices
                                                </a>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="o_profitability_wrapper" name="construction_site" t-if="myproject.is_construction_site">
                        <div class="o_profitability_section">
                            <div>
                                <table class="table">
                                    <tbody>
                                        <tr>
                                            <th colspan="3">
                                                    <span>Stages Decont</span>
                                                    <span class="oe_button oe_form_button oe_highlight fa fa-fw fa-usd"/>
                                            </th>
                                        </tr>
                                        <tr>
                                            <th>Task</th>
                                            <th>Planned Amount</th>
                                            <th>Statement Amount</th>
                                            <th>Stage</th>
                                            <th>State</th>
                                        </tr>
                                        <t t-foreach="myproject.task_ids" t-as="peoject_task">
                                            <tr>
                                                <td class="o_timesheet_plan_dashboard_cell">
                                                    <span t-field="peoject_task.name"/>
                                                </td>
                                                <td class="o_timesheet_plan_dashboard_cell">
                                                    <span t-field="peoject_task.total_sale_price_planned"/>
                                                </td>
                                                <td class="o_timesheet_plan_dashboard_cell">
                                                    <span t-field="peoject_task.total_sale_price_received"/>
                                                </td>
                                                <td class="o_timesheet_plan_dashboard_cell">
                                                    <span t-field="peoject_task.stage_id"/>
                                                </td>
                                                <td class="o_timesheet_plan_dashboard_cell">
                                                    <span t-field="peoject_task.kanban_state"/>
                                                </td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    </t>
                </xpath>
        </field>
    </record>

    <record id="project_project_view_kanban_inherit_sale_timesheet" model="ir.ui.view">
        <field name="name">project.project.kanban.inherit.sale.timesheet</field>
        <field name="model">project.project</field>
        <field name="inherit_id" ref="hr_timesheet.view_project_kanban_inherited"/>
        <field name="priority" eval="50"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='allow_timesheets']" position="after">
                <field name="is_construction_site" invisible="1"/>
            </xpath>
            <xpath expr="//a[@name='action_view_timesheet']" position="replace">
                <a t-if="record.is_construction_site" name="action_view_timesheet" type="object" class="o_project_kanban_box o_project_timesheet_box" groups="project.group_project_manager">
                    <div>
                        <span class="o_label">Project Overview</span>
                    </div>
                </a>
            </xpath>
        </field>
    </record>
</odoo>
